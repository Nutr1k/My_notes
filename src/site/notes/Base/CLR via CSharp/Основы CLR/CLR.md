---
{"dg-publish":true,"permalink":"/base/clr-via-c-sharp/osnovy-clr/clr/"}
---


CLR (Command Language Runtime) — Общеязыковая среда выполнения(В ней выполняется код). CLR подходит для разных языков программирования (С++, С#, Visual Basic, F#).

Она отвечает:
1. За управление памятью
2. Обработка исключений
3. Загрузка сборок
4. Синхронизация

Исходный код может исполняться в среде CLR если компилятор этого языка поддерживает среду выполнения CLR. 

Можно для сторонних языков разработать компиляторы поддерживающие CLR. К примеру компилятор для Python поддерживающий CLR разработали Microsoft и назвали IronPython

Независимые компании, сообщества, люди могут создавать компиляторы для выполнения исходного кода в CLR.

Компилятор поддерживающий CLR транслирует код в общий вид(IL код), следовательно, среда CLR не знает на каком языке написан исходный код. Впоследствии CLR компилирует IL в машинные команды

CLR совместимые компиляторы генерируют IL (CIL, MSIL) код и [[Base/CLR via CSharp/Основы CLR/Метаданные\|метаданные]].

В компиляторах поддерживающих CLR метаданные всегда связанны с IL кодом, они встроены в .EXE или .DLL
Модель выполнения кода в среде CLR
![Pasted image 20230129152453.png](/img/user/Files/Image/Pasted%20image%2020230129152453.png)

Результатом компиляции всегда будет _[[Base/CLR via CSharp/Основы CLR/Управляемый модуль(PE файл)\|управляемый модуль]]_ содержащий в себе IL код и метаданные. Потом управляемые модули объединяются в [[Base/CLR via CSharp/Основы CLR/Cборка\|сборку]].

Языки программирования C#, Visual Basic, F# и IL-ассемблер всегда создают модули, содержащие **управляемый код (IL)** и **управляемые данные**(данные, поддерживающие сборку мусора). Для выполнения любого управляемого модуля на машине конечного пользователя должна быть установлена среда CLR (в составе .NET Framework).

Компилятор для C++ может создавать .EXE и .DLL файлы содержащие неуправляемый код так и файлы содержащие управляемый код. В коде можно смешивать управляемые и неуправляемый код.

![Pasted image 20230131180402.png](/img/user/Files/Image/Pasted%20image%2020230131180402.png)

Среда выполнения [[Base/CLR via CSharp/Основы CLR/NET Core\|.NET]] взаимодействует с собственным машинным кодом JIT в том смысле, что среда выполнения владеет блоками памяти, занятыми собственным машинным кодом, среда выполнения вызывает собственный машинный код и т. д.

По сути JITCompiller входит в среду CLR и не должен выходить из блока CLR
![Pasted image 20230131174145.png](/img/user/Files/Image/Pasted%20image%2020230131174145.png)


Что делает CLR на примере:
![Pasted image 20230131181858.png](/img/user/Files/Image/Pasted%20image%2020230131181858.png)


1. Перед выполнением метода **Main** среда _CLR_ находит все типы данных на которые ссылается программный код метода **Main**
В данном случае **Main** ссылается только на тип <u>Console</u>
2. Среда _CLR_ выделяет одну внутреннюю структуру
Эта внутренняя структура содержит по одной записи для каждого метода, определённого в типе Console.
Каждая запись содержит адрес, по которому можно найти реализацию метода. 
3. При инициализации этой структуры _CLR_ заносит в каждую запись адрес внутренней недокументированной функции(JITCompiler), содержащейся в самой среде _CLR_.
Когда метод **Main** первый раз обращается к методу WriteLine, вызывается функция JITCompiler. Она отвечает за компиляцию IL-кода вызываемого метода в собственные команды процессора.
[[Base/CLR via CSharp/Основы CLR/JIT-компилятор#^861024\|JIT-компилятор]]



При запуске исполняемого файла Windows анализирует заголовок EXE-файла для определения того, какое именно адресное пространство необходимо для его работы —32- или 64-разрядное. Файл с заголовком PE32 может выполняться в адресном пространстве любого из указанных двух типов, а файлу с заголовком PE32+ требуется 64-разрядное пространство. Windows также проверяет информацию о процессорной архитектуре на совместимость с заданной конфигурацией. Наконец, 64-разрядные версии Windows поддерживают технологию выполнения 32-разрядных приложений в 64-разрядной среде, которая называется WoW64 (Windows on Windows64).

Влияние значения /platform на получаемый модуль. и режим выполнения
![Pasted image 20230304170745.png](/img/user/Files/Image/Pasted%20image%2020230304170745.png)
